---
name: "Check for new sqlite version"

on:
  workflow_dispatch:
    inputs:
      sqlite_version:
        description: 'SQLite version (leave empty to auto-detect latest)'
        required: false
        type: string
  schedule:
    # Run at random time (03:49), every monday
    - cron: "49 3 * * 1"


jobs:
  check-sqlite-version:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      execute-update: ${{ steps.version_check.outputs.UPDATE_VERSION }}
      sqlite-version: ${{ steps.version_check.outputs.SQLITE_VERSION }}
    steps:
      - name: "Get sqlite version"
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ inputs.sqlite_version }}" ]; then
            echo "Using provided version: ${{ inputs.sqlite_version }}"
            echo SQLITE_VERSION="${{ inputs.sqlite_version }}" >> "$GITHUB_ENV"
          else
            echo "Auto-detecting latest version from xerial/sqlite-jdbc"
            echo SQLITE_VERSION="$(gh api /repos/xerial/sqlite-jdbc/releases/latest --jq '.tag_name')" >> "$GITHUB_ENV"
          fi

      - name: "Verify tag exists in this repo"
        id: version_check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh api /repos/${{github.repository}}/tags --jq '.[].name' |grep -q -- '${{ env.SQLITE_VERSION }}'; then
             echo "Geotools version ${{env.SQLITE_VERSION}} was found from project tags. Doing nothing."
             
          else
             echo "Triggering geotools build action for sqlite: ${{env.SQLITE_VERSION}}";
             echo "UPDATE_VERSION=true" >> "$GITHUB_OUTPUT"
             echo "SQLITE_VERSION=${{ env.SQLITE_VERSION }}" >> "$GITHUB_OUTPUT"

          fi

  trigger-sqlite-build:
    if: needs.check-sqlite-version.outputs.execute-update == 'true'
    needs: check-sqlite-version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      SQLITE_VERSION: ${{ needs.check-geoserver-version.outputs.geoserver-version }}
    steps:
      - name: "Pull repo"
        uses: actions/checkout@v4
      - name: "trigger build"
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh workflow run "Build SQLite with ICU" --field sqliteVersion=${{ env.SQLITE_VERSION }}


